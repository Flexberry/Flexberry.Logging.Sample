# Изменения в лог-сервисах

## Общее устройство лог-сервиса

Архитектура лог-сервиса представляется следующим образом. Каждый сервис отдельно шлет лог. В случае бэкенда - с помощью `log4net`, в случае фронтенда (и других возможных сервисов) - с помощью адаптера. Логи собирает сборщик. В нашем случае в связке с Grafana Loki сборщиком является `promtail`. После чего логи попадают в базу данных Loki, а оттуда в инструмент анализа Grafana. В Grafana можно зайти через веб-интерфейс и искать логи.

Чтобы обеспечить передачу логов по http используется пакет `NewPlatfrom.Flexberry.LogService`. Пакет поддерживает работу и с netframework и netstandart. Этот пакет состоит из `LogRequest`, который принимает на вход логи; `Extensions`, которые настраивают роуты (причем для netframework и netstandart используются разные классы расширений); `LogsController`, который производит отправку логов.

## Аппендеры log4net

Для записи лога на бэкенде используется библиотека `Log4Net`. Настройка log4net может осуществляться как и внутри фала App.config, так и отдельном файле например в файле Test.exe.log4net, где Test меняется на название приложения или Web.config для web приложений.

В файле App.config или Web.config в самое начало после открытого тега `<configuration>` вставляем:

    <configSections>
      <section name="log4net" type="System.Configuration.IgnoreSectionHandler"/>
    </configSections>

Эта настройка указывает, что настройки для log4net находятся в секции "log4net". "System.Configuration.IgnoreSectionHandler" - указывает чем будет разбираться этот файл. Далее вставляем основные настройки логера (настройки могут варьироваться для разных проектов):

    <log4net>
    <appender name="LogFileAppender" type="log4net.Appender.RollingFileAppender">
      <param name="File" value="logs/odatabackend.log" />
      <param name="AppendToFile" value="true" />
      <param name="RollingStyle" value="Date" />
      <param name="Encoding" value="utf-8" />
      <layout type="log4net.Layout.PatternLayout">
        <param name="ConversionPattern" value="%-5p %d{yyyy-MM-dd hh:mm:ss} [%t] %m%n" />
      </layout>
    </appender>
    <appender name="ConsoleAppender" type="log4net.Appender.ConsoleAppender">
      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="%date [%thread] %-5level %logger [%property{NDC}] - %message%newline" />
      </layout>
    </appender>
    <appender name="LokiAppender" type="log4net.Appender.LokiAppender, log4net.Appender.Loki">
      <BufferSize  value="1" />
      <ServiceUrl value="http://localhost:3100" />
      <label>
        <key value="environment" />
        <value value="debug" />
      </label>
      <label>
        <key value="app" />
        <value value="FlexberrySampleLogging" />
      </label>
    </appender>
    <root>
      <level value="DEBUG" />
      <appender-ref ref="LogFileAppender" />
      <appender-ref ref="ConsoleAppender" />
      <appender-ref ref="LokiAppender" />
    </root>
    </log4net>

`appender` - описывает куда будет выводится лог, в данном случае вывод происходит в перезаписываемый файл - log4net.Appender.RollingFileAppender, в консоль, и отправляется в Loki. Для Loki также установлен пакет log4net.LokiAppender.

`level value` - уровень записи лога. мы выводим сообщения не ниже уровня DEBUG.

Для отправки сообщений в лог используется пакет `LogService` -  пакет для ведения логов в log4net. Этот пакет - обертка класса `ILog`, который ялвяется стандартым интерфейсом отправки сообщений log4net framework.  Лог отправляется в виде: `LogService.LogInfo("Это лог.");` Где `LogInfo` - это уровень лога. Лог может быть не только строкой, но и в формате json. Подробнее об этом - в статье "Работа с Grafana Loki".

## Изменения в лог-сервисе фронтенда

Ember записывает логи в базу данных в таблицу LogApplication. Теперь в `environment` будет доступен флаг `sendViaHttp`. С включенным флагом эмбер-методы отправки лога будут переопределяться и отправляться в лог-сервис.
